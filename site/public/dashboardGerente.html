<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Dashboard | Bem vindo(a)!</title>

    <!-- Montserrat Font -->
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./css/usoGeralDash.css">
    <link rel="stylesheet" href="./css/dashboardGerente.css">
    <link rel="stylesheet" href="./css/cadastrosDash.css">
    <link rel="stylesheet" href="./css/chamadosDash.css">
    <link rel="stylesheet" href="./css/relatoriosDash.css">
    <link rel="stylesheet" href="./css/configDash.css">
    <link rel="stylesheet" href="./css/perfil.css">
    <link rel="stylesheet" href="./css/validation.css">
    <!-- Favicon -->
    <link rel="shortcut icon" href="./assets/Symbol_tracking.png" type="image/x-icon">
</head>

<body>
    <div class="grid-container">
        <!-- Header -->
        <header class="header">
            <div class="menu-icon" onclick="openSidebar()">
                <span class="material-icons-outlined">menu</span>
            </div>
            <div class="header-left" id="nome">
                <p class="client-name-p">Olá, <b id="clientName"></b></p>
            </div>
            <div class="header-right">
                <!-- <span class="material-icons-outlined">notifications</span> -->
                <span class="material-icons-outlined perfil" onclick="mostrarPerfil()">person</span>
            </div>
        </header>
        <!-- End Header -->

        <!-- Sidebar -->
        <aside id="sidebar">

            <div class="sidebar-title">
                <div class="sidebar-brand">
                    <a href="dashboard.html">
                        <img src="assets/logo-tracking-monitor__1_-removebg-preview.png" id="logo">
                    </a>

                </div>
                <span class="material-icons-outlined" onclick="closeSidebar()">close</span>
            </div>

            <!-- :BARRA DE NAVEGAÇÃO -->
            <ul class="sidebar-list">
                <li class="sidebar-list-item" onclick="mostrarPainelDeControle()">
                    <div class="btn-side">
                        <span class="material-icons-outlined">poll</span>
                        Painel de controle
                    </div>
                </li>
                <li class="sidebar-list-item" onclick="mostrarCadastroFunc()">
                    <div class="btn-side">
                        <span class="material-icons-outlined">person_add</span>
                        Cadastrar funcionário
                    </div>
                </li>
                <li class="sidebar-list-item" onclick="mostrarRelatorios()">
                    <div class="btn-side">
                        <span class="material-icons-outlined">description</span>
                        Relatórios
                    </div>
                </li>
                <li class="sidebar-list-item" onclick="mostrarSuporte()">
                    <div class="btn-side">
                        <span class="material-icons-outlined">call</span>
                        Suporte
                    </div>
                </li>
                <li class="sidebar-list-item" onclick="logout()">
                    <div class="btn-side">
                        <span class="material-icons-outlined">logout</span>
                        Sair
                    </div>
                </li>
            </ul>
        </aside>
        <!-- End Sidebar -->

        <!-- Main -->
        <main class="main-container">
            <!-- Container dashboard -->
            <div class="caixa-botao-add-n" id="botaoMaquina" onclick="adicionarMaquina() ">
                Cadastrar Máquina
                <span class="material-icons-outlined btn-add">
                    add_box
                </span>
            </div>

            <div class="container-maquinas" id="containerMaquinas">

            </div>

            <!-- Container perfil -->
            <div class="box_account" id="containerPerfil">
                <div class="account_left">
                    <div class="box_users">
                        <svg id="svg-users" height="100" viewBox="0 0 100 100" width="100"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="m99.934721 83.101783q0 7.773452-5.168453 12.275576-5.168451 4.502123-13.735343 4.502123h-61.879837q-8.56689 0-13.7353442-4.502123-5.16845309-4.502124-5.16845309-12.275576 0-3.433274.24780238-6.704604.24780223-3.271327.99121081-7.060883.7434068-3.789558 1.8762197-7.028496 1.1328113-3.238939 3.0444311-6.31593 1.9116197-3.076992 4.3896463-5.247079 2.478024-2.170088 6.053461-3.465665 3.575439-1.295575 7.894283-1.295575.637206 0 2.973631 1.392744 2.336422 1.392743 5.274654 3.10938 2.938231 1.716638 7.64648 3.109381 4.708249 1.392745 9.451899 1.392745 4.743648 0 9.451893-1.392745 4.708247-1.392743 7.646479-3.109381 2.938231-1.716637 5.274655-3.10938 2.336425-1.392744 2.973631-1.392744 4.318846 0 7.894282 1.295575 3.575438 1.295577 6.053464 3.465665 2.478025 2.170087 4.389644 5.247079 1.91162 3.076991 3.044432 6.31593 1.132812 3.238938 1.87622 7.028496.743407 3.789556.991209 7.060883.247803 3.27133.247803 6.704604zm-22.656235-57.847437q0 10.299824-7.965082 17.587435-7.965083 7.287611-19.222395 7.287611-11.257316 0-19.222401-7.287611-7.965081-7.287611-7.965081-17.587435 0-10.299824 7.965081-17.5874341 7.965085-7.28761014 19.222401-7.28761014 11.257312 0 19.222395 7.28761014 7.965082 7.2876101 7.965082 17.5874341z"
                                fill="#AAA" />
                        </svg>
                    </div>
                </div>
                <div class="account_right">
                    <div class="alterar_senha">
                        <h2 class="titulo_senha">
                            Configurações de conta
                        </h2>
                        <div class="ipt_alterar_senha">
                            <h4>Senha atual:</h4>
                            <input type="text" name="" id="ipt_senha_antiga" placeholder="Senha atual">
                        </div>

                        <div class="ipt_alterar_senha">
                            <h4>Nova senha:</h4>
                            <input type="text" name="" id="ipt_senha_nova" placeholder="Nova senha">
                        </div>

                        <div class="ipt_alterar_senha">
                            <h4>Confirme sua nova senha:</h4>
                            <input type="text" name="" id="ipt_senha_nova_confirm"
                                placeholder="Digitar novamente a senha">
                        </div>

                        <button class="btn_salvar" onclick="alterarSenha()">Salvar Senha</button>
                    </div>

                    <div class="deletar_conta">
                        <h2 class="tittle" id="tittle_delete">Deseja excluir sua conta?</h2>
                        <button id="btn_delete" class="btn_del" onclick="deletar()">Excluir conta</button>
                        <!-- <div id="are_sure" style="display: none;" class="are_you_sure">
                            <button onclick="cancel()" class="btn_cancel">Cancelar</button>
                            <button onclick="deletar()" class="btn_delete">Excluir</button>
                        </div> -->
                    </div>

                </div>
            </div>

            <!-- Fim perfil -->

            <!-- Container cadastar func -->
            <div class="caixa-botao-add-n" style="display: none;" id="botaoFuncionario" onclick="adicionarFunc()">
                Cadastrar funcionário
                <span class="material-icons-outlined" style="font-size: 25px;">
                    add_box
                </span>
            </div>
            <div class="container-cadastro" id="containerCadastroFunc">
                <div class="container-das-infos" id="containerFuncionario">

                </div>
            </div>
            <!-- Container formulario de cadastros Máquina-->
            <div class="form-cadastro" id="mostrarFormMaq">
                <div class="div-voltar">
                    <button class="btn-voltar" onclick="mostrarCadastroMaq()">
                        &#171;
                    </button>
                </div>
                <div class="primeiro-bloco-cadas" style="margin-right: 30px;">
                    <span class="campo">
                        Nome da Maquina <Input class="campo-input" id="host_input"
                            placeholder="Digite o nome da máquina" onblur="validarNomeMaquina()""></Input>
                    </span>
                    <span class=" campo">
                        Bairro <Input class="campo-input" id="bairro_input" placeholder="Digite o bairro" maxlength="45"
                            onblur="validarBairro()"></Input>
                    </span>
                    <span class="campo">
                        Complemento <Input class="campo-input" id="complemento_input" placeholder="Digite o complemento"
                            maxlength="45" onblur="validarComplemento()"></Input>
                    </span>
                    <span class="campo">
                        Cep <Input class="campo-input" id="cep_input" placeholder="Digite o cep" maxlength="9"
                            oninput="mascaraCEP(this, 'cep')" autocomplete="on" onblur="validarCep()"></Input>
                    </span>
                </div>
                <div class="primeiro-bloco-cadas" style="align-items: flex-start; justify-content: flex-start;;">
                    <span class="campo">
                        Estado <Input class="campo-input" id="estado_input" placeholder="Digite o estado" maxlength="45"
                            onblur="validarEstado()"></Input>
                    </span>
                    <span class="campo">
                        Cidade <Input class="campo-input" id="cidade_input" placeholder="Digite a cidade" maxlength="45"
                            onblur="validarCidade()"></Input>
                    </span>
                    <span class="campo">
                        Logradouro <Input class="campo-input" id="logradouro_input" placeholder="Digite o logradouro"
                            maxlength="45" onblur="validarLogradouro()"></Input>
                    </span>
                    <span class="campo">
                        Número <Input class="campo-input" id="numero_input" placeholder="Digite o número" maxlength="6"
                            onblur="validarNumero()"></Input>
                    </span>
                </div>
                <div class="div-confirmar-cadastro">
                    <button class="btn-confirmar-cadastro" onclick="cadastrarMaquina()">
                        Cadastrar
                    </button>
                </div>
            </div>
            <!-- Container formulario de cadastros Funcionário -->
            <!-- <div class="form-cadastro" id="mostrarFormFunc">
                <div class="div-voltar">
                    <button class="btn-voltar" onclick="mostrarCadastroFunc()">
                        voltar
                    </button>
                </div> -->
            <div class="form-cadastro" id="mostrarFormFunc">
                <div class="div-voltar">
                    <button class="btn-voltar" onclick="mostrarCadastroFunc()">
                        &#171;
                    </button>
                </div>
                <div class="primeiro-bloco-cadas" style="margin-right: 30px;">
                    <span class="campo">
                        Nome <Input class="campo-input" id="nome_input" placeholder="Digite o nome da máquina"
                            onblur="validarNome()"></Input>
                    </span>
                    <span class="campo">
                        Email <Input class="campo-input" id="email_input" placeholder="Digite o cep"
                            onblur="validarEmail()"></Input>
                    </span>
                    <span class="campo">
                        Cpf <Input class="campo-input" id="cpf_input" placeholder="Digite o estado"
                            onblur="validarCpf()"></Input>
                    </span>
                    <span class="campo">
                        Senha <Input class="campo-input" id="senha_input" placeholder="Digite a cidade"
                            onblur="validarSenha()"></Input>
                    </span>
                </div>
                <div class="div-confirmar-cadastro">
                    <button class="btn-confirmar-cadastro" onclick="cadastrarFuncionario()">
                        Cadastrar
                    </button>
                </div>
            </div>

            <!-- Container relatorios -->
            <div class="container-relatorios" id="containerRelatorios">
                <table>
                    <caption>Relatórios</caption>
                    <thead>
                        <tr>
                            <th scope="col">Data</th>
                            <th scope="col">Qtd máquinas que atingiram o limite</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td data-label="Due Date">26/04/2023</td>
                            <td data-label="Amount">7</td>
                        </tr>
                        <tr>
                            <td data-label="Due Date">26/04/2023</td>
                            <td data-label="Amount">7</td>
                        </tr>
                        <tr>
                            <td data-label="Due Date">26/04/2023</td>
                            <td data-label="Amount">7</td>
                        </tr>
                        <tr>
                            <td data-label="Due Date">26/04/2023</td>
                            <td data-label="Amount">7</td>
                        </tr>

                        <tr>
                            <td data-label="Due Date">26/04/2023</td>
                            <td data-label="Amount">7</td>
                        </tr>

                        <tr>
                            <td data-label="Due Date">26/04/2023</td>
                            <td data-label="Amount">7</td>
                        </tr>

                        <tr>
                            <td data-label="Due Date">26/04/2023</td>
                            <td data-label="Amount">7</td>
                        </tr>

                        <tr>
                            <td data-label="Due Date">26/04/2023</td>
                            <td data-label="Amount">7</td>
                        </tr>

                    </tbody>
                </table>
            </div>

            <!-- Container suporte -->
            <div class="container-suporte" id="containerSuporte">
                <table>
                    <caption>Suporte</caption>
                    <thead>
                        <tr>
                            <th scope="col">ID Chamado</th>
                            <th scope="col">Hostname</th>
                            <th scope="col">Localidade</th>
                            <th scope="col">Descrição</th>
                            <th scope="col">Situação</th>
                            <th scope="col">Overview</th>

                        </tr>
                    </thead>

                </table>
            </div>

            <!-- container suporte -->
            <!-- End Main -->


            <!-- Scripts -->

            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.10.1/dist/sweetalert2.all.min.js"></script>
            <!-- ApexCharts -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.35.3/apexcharts.min.js"></script>
            <!-- Custom JS -->
            <script src="./js/sidebarGerente.js"></script>
            <script src="./js/validation.js"></script>
</body>

</html>

<script>
    clientName.innerHTML = sessionStorage.NOME_PERFIL;

    function cadastrarMaquina() {
        //Recupere o valor da nova input pelo nome do id
        // Agora vá para o método fetch logo abaixo
        var cepVar = cep_input.value;
        var estadoVar = estado_input.value;
        var cidadeVar = cidade_input.value;
        var bairroVar = bairro_input.value;
        var logradouroVar = logradouro_input.value;
        var numeroVar = numero_input.value;
        var complementoVar = complemento_input.value;

        if (
            cepVar == "" ||
            estadoVar == "" ||
            cidadeVar == "" ||
            logradouroVar == "" ||
            numeroVar == "" ||
            bairroVar == "" ||
            complementoVar == ""
        ) {
            // finalizarAguardar();
            return false;

        } else if (validarMaquina()) {
            // Enviando o valor da nova input
            fetch("/maquina/cadastrarEndereco", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    // crie um atributo que recebe o valor recuperado aqui
                    // Agora vá para o arquivo routes/usuario.js
                    cepServer: cepVar,
                    estadoServer: estadoVar,
                    cidadeServer: cidadeVar,
                    logradouroServer: logradouroVar,
                    numeroServer: numeroVar,
                    bairroServer: bairroVar,
                    complementoServer: complementoVar
                })
            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    cadastrarFetchMaquina();

                    Swal.fire({
                        position: 'center',
                        icon: "success",
                        title: 'Maquina cadastrada com sucesso!',
                        showConfirmButton: false,
                        timer: 1500
                    })
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);

                    console.log(resposta);
                    // limparFormulario();
                    // finalizarAguardar();
                } else {
                    throw ("Houve um erro ao tentar realizar o cadastro!");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                // finalizarAguardar();
            });

            return false;
        }
    }

    function cadastrarFetchMaquina() {
        var cepVar = cep_input.value;
        var estadoVar = estado_input.value;
        var cidadeVar = cidade_input.value;
        var bairroVar = bairro_input.value;
        var logradouroVar = logradouro_input.value;
        var numeroVar = numero_input.value;
        var complementoVar = complemento_input.value;
        var nomeMaquinaVar = host_input.value;
        fetch(`/maquina/cadastrarMaquina/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                nomeMaquinaServer: nomeMaquinaVar,
                fkPerfilServer: sessionStorage.ID_PERFIL,
                cepServer: cepVar,
                estadoServer: estadoVar,
                cidadeServer: cidadeVar,
                logradouroServer: logradouroVar,
                numeroServer: numeroVar,
                bairroServer: bairroVar,
                complementoServer: complementoVar
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {


                console.log(resposta);
                // limparFormulario();
                // finalizarAguardar();
            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            // finalizarAguardar();
        });
    }

    function cadastrarFuncionario() {
        //Recupere o valor da nova input pelo nome do id
        // Agora vá para o método fetch logo abaixo
        var nomeVar = nome_input.value;
        var emailVar = email_input.value;
        var senhaVar = senha_input.value;
        var cpfVar = cpf_input.value;

        if (nomeVar == "" || emailVar == "" || senhaVar == "" || cpfVar == "") {
            // finalizarAguardar();
            return false;

        } else if (validarCadastro()) {
            // Enviando o valor da nova input
            fetch("/perfil/cadastrarFuncionario", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    // crie um atributo que recebe o valor recuperado aqui
                    // Agora vá para o arquivo routes/usuario.js
                    nomeServer: nomeVar,
                    emailServer: emailVar,
                    senhaServer: senhaVar,
                    cpfServer: cpfVar,
                    fkPerfilServer: sessionStorage.ID_PERFIL

                })
            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    setTimeout(() => {
                        window.location.reload();
                    }, "1600")

                    // limparFormulario();
                    // finalizarAguardar();
                } else {
                    throw ("Houve um erro ao tentar realizar o cadastro!");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                // finalizarAguardar();
            });

            return false;
        }

    }


    function buscarDadosFuncionario() {

        fetch(`/maquina/buscarDadosFuncionario/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkIdGerente: sessionStorage.ID_PERFIL
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    for (let i = 0; i < resposta.length; i++) {

                        containerFuncionario.innerHTML += `
                            <div class="caixa-infos">
                                ${resposta[i].nome}
                                <img src="https://moodle.sptech.school/theme/image.php/degrade/core/1643201436/u/f1"
                                    class="func">
                                    <span>
                                        id: ${resposta[i].idPerfil}
                                    </span>

                                    <span>
                                        
                                    </span>
                                </span>
                                <div class="caixa-botao-add" onclick="deletarFunc(${resposta[i].idPerfil}) ">
                                        <span class="material-icons-outlined btn-add">
                                            delete
                                        </span>
                                        Excluir funcionário
                                </div>
                            </div > 
                            `;
                    }
                });
                console.log(resposta);
            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function buscarDadosMaquina() {
        fetch(`/maquina/buscarDadosMaquina/${sessionStorage.ID_PERFIL}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkIdGerente: sessionStorage.ID_PERFIL
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    for (let i = 0; i < resposta.length; i++) {
                        const maquina = resposta.IdMaquina;
                        containerMaquinas.innerHTML += `
            <div class="caixa-maquina">
                <Span style="font-size: 20px;">${resposta[i].nomeMaquina}</Span>
                <div class="kpi"></div>
                <img src="./assets/img-computer-tracking-removebg-preview.png" class="computer" alt="">
                <span>Estado de operação: </span>
                <span>Sitema operacional: ${resposta[i].sistemaOperacional}</span>
                <div class="caixa-botao-add" onclick="deletarMaquina( ${resposta[i].idMaquinaCorporativa}) ">
                        <span class="material-icons-outlined btn-add">
                            delete
                        </span>
                        Excluir Máquina
                 </div>
            </div>
                        `
                    }
                });


                console.log(resposta);
            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function deletarMaquina(idMaquina) {
        if (confirm("Deseja mesmo deletar está máquina???")) {

            fetch(`/maquina/deletar/${idMaquina}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    ID: idMaquina

                })
            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    location.reload();
                } else {
                    throw ("Houve um erro ao tentar deletar a máquina");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        }
    }

    function deletarFunc(idFunc) {
        if (confirm("Deseja mesmo deletar este funcionário???")) {

            fetch(`/perfil/deletar/${idFunc}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    IDF: idFunc
                })
            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    location.reload();
                } else {
                    throw ("Houve um erro ao tentar deletar o funcionário");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        }
    }

    buscarDadosMaquina()
    buscarDadosFuncionario()
</script>

<!-- funções de alterar -->
<script>
    function alterarSenha() {
        var senhaAntigaServer = ipt_senha_antiga.value;
        var senhaNovaServer = ipt_senha_nova.value;
        var senhaNovaConfirmServer = ipt_senha_nova_confirm.value;


        if (senhaNovaServer !== senhaNovaConfirmServer) {
            alert("As senhas não conferem");
            return false;
        }

        fetch("/perfil/alterarsenha/" + sessionStorage.ID_PERFIL, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                senhaNovaServer,
                senhaAntigaServer
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO atualizar()!")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    alert("Senha alterada com sucesso! Faça o login novamente")

                });

            } else {

                console.log("Houve um erro ao tentar alterar a senha");

                resposta.text().then(texto => {
                    console.error(texto);

                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;

    }



    function deletar() {

        fetch("/perfil/deletar" + sessionStorage.ID_PERFIL, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO deletar()!")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    alert("Usuário deletado com sucesso! Faça o login com outro usuário")

                

                });

            } else {

                console.log("Houve um erro ao tentar deletar o usuário");

                resposta.text().then(texto => {
                    console.error(texto);
                    // finalizarAguardar(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;

    }
</script>